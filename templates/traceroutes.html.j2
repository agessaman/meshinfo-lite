{% set this_page = "traceroutes" %}
{% extends "layout.html.j2" %}

{% block title %}Traceroutes | MeshInfo{% endblock %}

{% block content %}
<div class="container pt-3">
  <h5>{{ this_page.title() }}</h5>
  
  <table class="table table-striped table-bordered table-sm">
    <thead>
      <tr>
        <th scope="col">Timestamp</th>
        <th scope="col">From</th>
        <th scope="col">To</th>
        <th scope="col">Route</th>
        <th scope="col">Route Hops</th>
      </tr>
    </thead>
    <tbody>
      {% for item in traceroutes %}
        <tr>
          <td>{{ format_timestamp(item.ts_created) }}</td>
          <td>
            {% set fnodeid = utils.convert_node_id_from_int_to_hex(item["from_id"]) %}
            {% if fnodeid in nodes %}
              <a href="node_{{ fnodeid }}.html">{{ nodes[fnodeid].short_name }}</a>
            {% else %}
              <span>UNK</span>
            {% endif %}
          </td>
          <td>
            {% set tnodeid = utils.convert_node_id_from_int_to_hex(item["to_id"]) %}
            {% if tnodeid in nodes %}
              <a href="node_{{ tnodeid }}.html">{{ nodes[tnodeid].short_name }}</a>
            {% else %}
              <span>UNK</span>
            {% endif %}
          </td>
          <td>
            <div class="d-flex align-items-center flex-wrap">
              {% set fnodeid = utils.convert_node_id_from_int_to_hex(item["from_id"]) %}
              <div class="d-inline-flex align-items-center me-2 mb-1">
                <div class="position-relative">
                  {% if fnodeid in nodes %}
                    <a href="node_{{ fnodeid }}.html" class="text-decoration-none fw-bold">
                      {{ nodes[fnodeid].short_name }}
                    </a>
                  {% else %}
                    <span class="fw-bold">UNK</span>
                  {% endif %}
                </div>
                <span class="mx-2">⇢</span>
              </div>

              {% for hop in item.route %}
                <div class="d-inline-flex align-items-center me-2 mb-1">
                  {% set hnodeid = utils.convert_node_id_from_int_to_hex(hop) %}
                  {% set hnode = nodes[hnodeid] if hnodeid in nodes else None %}
                  <div class="position-relative">
                    {% if hnode %}
                      <a href="node_{{ hnodeid }}.html" class="text-decoration-none">
                        {{ hnode.short_name }}
                      </a>
                    {% else %}
                      <span>UNK</span>
                    {% endif %}
                    {% if item.snr and loop.index0 < item.snr|length %}
                      {% set snr_value = item.snr[loop.index0] %}
                      {{ snr_badge(snr_value) }}
                    {% endif %}
                  </div>
                  {% if not loop.last %}
                    <span class="mx-2">⇢</span>
                  {% endif %}
                </div>
              {% endfor %}

              {% set tnodeid = utils.convert_node_id_from_int_to_hex(item["to_id"]) %}
              <div class="d-inline-flex align-items-center me-2 mb-1">
                {% if item.route|length > 0 %}
                  <span class="mx-2">⇢</span>
                {% endif %}
                <div class="position-relative">
                  {% if tnodeid in nodes %}
                    <a href="node_{{ tnodeid }}.html" class="text-decoration-none fw-bold">
                      {{ nodes[tnodeid].short_name }}
                    </a>
                  {% else %}
                    <span class="fw-bold">UNK</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </td>
          <td>{{ item.route | length }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pagination.total > pagination.per_page %}
    <nav aria-label="Traceroute pagination" class="table-responsive">
      <ul class="pagination justify-content-center mb-1">
        <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('traceroutes', page=1) }}" title="Newest traceroutes">Current</a>
        </li>
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('traceroutes', page=pagination.prev_num) }}" title="Previous page">Previous</a>
        </li>

        {% set start_page = [pagination.page - 5, 1] | max %}
        {% set end_page = [start_page + 10, pagination.pages] | min %}
        {% if end_page - start_page < 10 %}
          {% set start_page = [end_page - 10, 1] | max %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
          <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('traceroutes', page=page_num) }}">{{ page_num }}</a>
          </li>
        {% endfor %}

        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('traceroutes', page=pagination.next_num) }}" title="Next page">Next</a>
        </li>
        <li class="page-item {% if pagination.page == pagination.pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('traceroutes', page=pagination.pages) }}" title="Oldest traceroutes">Oldest</a>
        </li>
      </ul>
    </nav>

    <div class="text-center text-muted mt-2 mb-3">
      {% if pagination.total > 0 %}
        Showing {{ pagination.start_item }} 
        to {{ pagination.end_item }} 
        of {{ pagination.total }} traceroutes
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}